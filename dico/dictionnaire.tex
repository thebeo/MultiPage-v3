\def\dicover{V496}

\usepackage{tikz} % dessin
\usetikzlibrary{arrows.meta,bending,shapes.geometric,shapes.misc,positioning}
\usepackage{xparse} % for NewDocumentCommand

%%%%
\input{dico/dcparse.tex}
%%%%

%%%%%%
% Notes 
%%%%%%

%usage \Notes{note Note ...Note}[scale]

\NewDocumentCommand\Notes{m O{1.0}}
{
    \ParseNotes{#1}       
    \dcDrawNotes[#2]   
}


\ExplSyntaxOn
%usage \dcDrawNotes[scale]
% draw the notes in \l__CleanNote_seq
 \NewDocumentCommand\dcDrawNotes{O{1.0}}
{
    \tl_set_eq:NN \l__Size_tl \text
    \fp_zero_new:N \l__Scale_fp
    \fp_set:Nn \l__Scale_fp {#1}
        
        % Trace
        \iow_term:n {dcDrawNotes}
        \iow_term:n {#1}
        \fp_show:N \l__Scale_fp

    \fp_compare:nNnTF {\l__Scale_fp } = { 1 }
        {\tl_set_eq:NN \l__Size_tl \large}
        {}
    \fp_compare:nNnTF {\l__Scale_fp } = { .5 }
        {\tl_set_eq:NN \l__Size_tl \normalsize}
        {}
    
    
    % Draw each Note
    \seq_map_indexed_inline:Nn \l__CleanNote_seq  
    {    
        %Draw Pre & Note
        % constante in fact to test bool
        \str_set:Nn \l__true_str {true}
        
        \str_set:Ne \l__Pre_bool_str {\seq_item:Nn \l__Pre_bool_seq {##1}}
           
        \int_compare:nNnTF {##1}>{1} % not the first one
        {% not the first draw the -
            \str_if_eq:NNTF \l__Pre_bool_str \l__true_str
            {% yes Pre
                \tl_set:Ne \l__Pre_tl {\seq_item:Nn \l__Pre_seq {##1}}
                 % If not exist replace by the unkwow note
                \cs_if_exist:cTF{dc##2}
                {-\dcPreDraw{\l__Pre_tl}[#1]\use:c {dc##2}[\l__Size_tl]}
                {-\dcPreDraw{\l__Pre_tl}[#1]\use:c {dcUKw}[\l__Size_tl]} 
            }
            {% No Pre
                 % If not exist replace by the unkwow note
                \cs_if_exist:cTF{dc##2}
                {-\use:c {dc##2}[\l__Size_tl]}
                {-\use:c {dcUKw}[\l__Size_tl]}              
            }
        }
        {% the first
            \str_if_eq:NNTF \l__Pre_bool_str \l__true_str
            {% yes Pre
                \tl_set:Ne \l__Pre_tl {\seq_item:Nn \l__Pre_seq {##1}}
                 % If not exist replace by the unkwow note
                \cs_if_exist:cTF{dc##2}
                {\dcPreDraw{\l__Pre_tl}[#1]\use:c {dc##2}[\l__Size_tl]}
                {\dcPreDraw{\l__Pre_tl}[#1]\use:c {dcUKw}[\l__Size_tl]}            }
            {% No Pre 
                 % If not exist replace by the unkwow note
                \cs_if_exist:cTF{dc##2}
                {\use:c {dc##2}[\l__Size_tl]}
                {\use:c {dcUKw}[\l__Size_tl]}
            }
        }

    }
}
\ExplSyntaxOff

% Usage dcPreDraw: Draw Pre {Pre}
\ExplSyntaxOn
\NewDocumentCommand\dcPreDraw{m O{1.0}}{

        % Trace
        \iow_term:n {dcPreDraw}
        \iow_term:n {#1}
        

    \IfEqCase{#1} % what is requested ?
        {
        {/} %flame
            {
                \FL{black}[][#2]
            }
         {↓} %Down arrow
            {
                \DA{black}[#2]
            }
         {↑} %Up arrow
            {
                \UA{black}[#2]
            }
        }
        [% other
        #1x       
        ]
}
\ExplSyntaxOff

% usage: \ML{color}{nb} - multiply
\NewDocumentCommand\ML{mm}{\textcolor{#1}{\scriptsize{#2}x}}

% usage: \note{color}{texte}{gamme}  9=no deco
\ExplSyntaxOn
\NewDocumentCommand\note{mmm}
{
     \tl_clear_new:N \l__note_tl
%     \str_set:Ne \l__note_str {\textcolor{#1}{\textbf{#2}}}
    \tl_set:Nn \l__note_tl {\textcolor{#1}{\textbf{#2}}}    

    \str_clear_new:N \l__gamme_str
    \str_set:Ne \l__gamme_str {#3}

	\str_case:NnTF \l__gamme_str % what gamme
	{
		{-2} 	{ \DDC	{\l__note_tl} }
		{-1} 	{ \DC	{\l__note_tl} }
		{0}     { \UL	{\l__note_tl} }
		{1} 	{ \UC	{\l__note_tl} }
        {+1} 	{ \UC	{\l__note_tl} }
		{2} 	{ \DUC	{\l__note_tl} }
        {+2} 	{ \DUC	{\l__note_tl} }
		{9} 	{        \l__note_tl  }
	}
	{}% additional things if found
	{}% additional things if other
}
\ExplSyntaxOff


% usage: \do [gamme]
\NewDocumentCommand\DO{O{-1}}{\text{\note{do}{do}{#1}}}
% [size] \text to do nothing
\NewDocumentCommand\dcDOb{O{\text}}{{#1{\DO[-1]}}}
\NewDocumentCommand\dcDOu{O{\text}}{{#1{\DO[+1]}}}
\NewDocumentCommand\dcXDOb{O{\text}}{\CE{do}}
\NewDocumentCommand\dcXDOu{O{\text}}{\CE{do}}
% usage: \re 
\NewDocumentCommand\RE{O{0}}{\text{\note{re}{ré}{#1}}}
\NewDocumentCommand\dcREd{O{\text}}{{#1{\RE[-2]}}}
\NewDocumentCommand\dcREm{O{\text}}{{#1{\RE[0]}}}
\NewDocumentCommand\dcREh{O{\text}}{{#1{\RE[+2]}}}
\NewDocumentCommand\dcXREd{O{\text}}{\CE{re}}
\NewDocumentCommand\dcXREm{O{\text}}{\CE{re}}
\NewDocumentCommand\dcXREh{O{\text}}{\CE{re}}
% usage: \mi 
\NewDocumentCommand\MI{O{0}}{\text{\note{mi}{mi}{#1}}}
\NewDocumentCommand\dcMIl{O{\text}}{{#1{\MI[-2]}}}
\NewDocumentCommand\dcMIm{O{\text}}{{#1{\MI[0]}}}
\NewDocumentCommand\dcMIh{O{\text}}{{#1{\MI[+2]}}}
\NewDocumentCommand\dcXMIl{O{\text}}{\CE{mi}}
\NewDocumentCommand\dcXMIm{O{\text}}{\CE{mi}}
\NewDocumentCommand\dcXMIh{O{\text}}{\CE{mi}}
% usage: \fa 
\NewDocumentCommand\FA{O{+1}}{\text{\note{fa}{fa}{#1}}}
\NewDocumentCommand\dcFAl{O{\text}}{{#1{\FA[-2]}}}
\NewDocumentCommand\dcFAu{O{\text}}{{#1{\FA[+1]}}}
\NewDocumentCommand\dcFAh{O{\text}}{{#1{\FA[+2]}}}
\NewDocumentCommand\dcXFAl{O{\text}}{\CE{fa}}
\NewDocumentCommand\dcXFAu{O{\text}}{\CE{fa}}
\NewDocumentCommand\dcXFAh{O{\text}}{\CE{fa}}
% usage: \sol 
\NewDocumentCommand\SOL{O{+1}}{\text{\note{sol}{sol}{#1}}}
\NewDocumentCommand\dcSOLl{O{\text}}{{#1{\SOL[-2]}}}
\NewDocumentCommand\dcSOLu{O{\text}}{{#1{\SOL[+1]}}}
\NewDocumentCommand\dcSOLh{O{\text}}{{#1{\SOL[+2]}}}
\NewDocumentCommand\dcXSOLl{O{\text}}{\CE{sol}}
\NewDocumentCommand\dcXSOLu{O{\text}}{\CE{sol}}
\NewDocumentCommand\dcXSOLh{O{\text}}{\CE{sol}}
% usage: \la 
\NewDocumentCommand\LA{O{+1}}{\text{\note{la}{la}{#1}}}
\NewDocumentCommand\dcLAb{O{\text}}{{#1{\LA[-1]}}}
\NewDocumentCommand\dcLAu{O{\text}}{{#1{\LA[+1]}}}
\NewDocumentCommand\dcLAh{O{\text}}{{#1{\LA[+2]}}}
\NewDocumentCommand\dcXLAb{O{\text}}{\CE{la}}
\NewDocumentCommand\dcXLAu{O{\text}}{\CE{la}}
\NewDocumentCommand\dcXLAh{O{\text}}{\CE{la}}
% usage: \si 
\NewDocumentCommand\SI{O{-1}}{\text{\note{si}{si}{#1}}}
\NewDocumentCommand\dcSIb{O{\text}}{{#1{\SI[-1]}}}
\NewDocumentCommand\dcXSIb{O{\text}}{\CE{si}}

% usage: \uk unknown note 
\NewDocumentCommand\UK{O{0}}{\text{\note{uk}{uk}{#1}}}
\NewDocumentCommand\dcUKw{O{\text}}{{#1{\UK[0]}}}
\NewDocumentCommand\dcXUKw{O{\text}}{\CE{uk}}

%%%%%%
% Octave notation
%%%%%%

% size
\newdimen\sep
\sep=.05ex
\newdimen\depth
\depth=.3ex
\newdimen\betw
\betw=.4ex
\newdimen\linwd
\linwd=.5pt

% \DC - Arc Down
% usage: \DC{text}[scale] : \DC {re-mi} simple arc bellow
\NewDocumentCommand\DC{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.south west) parabola [parabola height=-\depth] (arced node.south east);
    }}}

% \DL - Ligne Down
% usage: \DL{text}[scale] : \DC{re-mi} simple lign bellow
\NewDocumentCommand\DL{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.south west) -- (arced node.south east);
    }}}

% \DDC - double Arc Down
% usage: \DDC{text}[scale]
\NewDocumentCommand\DDC{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.south west) parabola [parabola height=-\depth] (arced node.south east);
        \draw [line width=\linwd] [transform canvas={yshift=-\sep -\betw }] (arced node.south west) parabola [parabola height=-\depth] (arced node.south east);
    }}}

%\DDL - double ligne Down
% usage: \DUL{text}[scale] 
\NewDocumentCommand\DDL{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.south west) -- (arced node.south east);
        \draw [line width=\linwd] [transform canvas={yshift=-\sep -\betw }] (arced node.south west) -- (arced node.south east);
    }}}

% \UC - Arc Up
% usage: \UC{text}[scale] : \UC{re-mi}
\NewDocumentCommand\UC{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.north west) parabola [parabola height=+\depth] (arced node.north east);
    }}}

% \UL - Ligne UP
% usage: \UL{text}[scale] : \UC{re-mi}
\NewDocumentCommand\UL{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=-\sep}] (arced node.north west) -- (arced node.north east);
    }}}

% \DUC - Double Arc UP
% usage: \DUC{text}[scale] : \DUC{re-mi}
\NewDocumentCommand\DUC{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=\sep}] (arced node.north west) parabola [parabola height=+\depth] (arced node.north east);
        \draw [line width=\linwd] [transform canvas={yshift=\sep +\betw}] (arced node.north west) parabola [parabola height=+\depth] (arced node.north east);
    }}}

% \DUL - Double Ligne UP
% usage: \DUL{text}[scale] : \DUL{re-mi}
\NewDocumentCommand\DUL{m O{1.0}}{\scalebox{#2}{\tikz[baseline=(arced node.base)]{
        \node [inner sep=0pt, outer sep=0pt] (arced node) {#1};
        \draw [line width=\linwd] [transform canvas={yshift=\sep}] (arced node.north west) -- (arced node.north east);
        \draw [line width=\linwd] [transform canvas={yshift=\sep +\betw}] (arced node.north west) -- (arced node.north east);
    }}}



%%%%%%
% Arrows
%%%%%%

% usage: \UA{color}[scale] - Up Arrow
\NewDocumentCommand\UA{m O{1.0}}{\scalebox{#2}{\tikz[baseline=-0.5ex,>={Stealth}]{
    \path[draw=#1,line width=1pt,->](0ex,-1ex)--(0ex,1ex);
    }}\space}


% usage: \DA{color}[scale] - Down Arrow
\NewDocumentCommand\DA{m O{1.0}}{\scalebox{#2}{\tikz[baseline=-0.5ex,>={Stealth}]{
    \path[draw=#1,line width=1pt,->](0ex,1ex)--(0ex,-1ex);
    }}\space}

% usage: \UDA{color}[scale] - -Up-Down Arrow
\NewDocumentCommand\UDA{m O{1.0}}{\scalebox{#2}{\tikz[baseline=-0.5ex,,>={Stealth[round]}]{
    \path[draw=#1,line width=1pt,<->](0ex,1ex)--(0ex,-1ex);
    }}\space}


%%%%%%
% Chord
%%%%%%

% Usage \ST{B}{M}{H}[scale] - draw a stac 3 notes
\NewDocumentCommand\ST{mmm O{1.0}}{\scalebox{#4}{\tikz[baseline=0.ex]{
    \begin{scope}[node distance=0.4ex,inner sep=0pt,node font=\Large]
        \node[anchor=base] (M) at (0,0) {#2};
        \node [above=of M,anchor=south] (T) {#3};
        \node [below=of M,anchor=north] (B) {#1};
        
        \node [above=of T,anchor=south] (H) {};% extra space at TOP
        \node [below=of B,anchor=north] (L) {};% extra space at BOTTOM

    \end{scope}
    }}}

% usage: \LS{note F}[scale] - Lateral symbol of the Fundamental decoration
\newdimen\LSsize
\LSsize=1ex
\NewDocumentCommand\LS{O{1.0}}{\scalebox{#1}{\tikz[baseline=(B.base)]{
    \node (T) at (0,\LSsize) {};
    \node (B) at (0,-\LSsize) {};
    \path[draw=black,line width=.25pt](T)--(B);
    }}}

% usage: \FU{note F}[scale] - Fundamental decoration 
\NewDocumentCommand\FU{m O{1.0}}{\LS[#2]#1\LS[#2]}


\ExplSyntaxOn
\NewDocumentCommand\CH{mmmm O{1.0}}
{
	\str_case:NnTF #4 % what Inversion
	{
		{F}{\ST{\FU{#1}[#5]}{#2}{#3}}
		{T}{\ST{#2}{#3}{\FU{#1}[#5]}}
		{Q}{\ST{#3}{\FU{#1}[#5]}{#2}}
	}
	{% additional things if found
	}
	{% additional things if other
	}
		
}
\ExplSyntaxOff

% usage: \CE{color}[scale] - Empty in chord
%\NewDocumentCommand\CE{m}{\color{#1}{X}}
\newdimen\CEsize
\CEsize=7pt
\newdimen\CEwidth
\CEwidth=0.2pt
\NewDocumentCommand\CE{m O{1.0}}{\scalebox{#2}{\tikz[baseline=-\CEsize]{
    \path[draw=#1,line width=\CEwidth,-] (0,-\CEsize)--(\CEsize,\CEsize);
    \path[draw=#1,line width=\CEwidth,-] (0,\CEsize)--(\CEsize,-\CEsize);
    }}}

\newdimen\ARPArrowSize
\ARPArrowSize=3ex
\newdimen\ARPArrowBAseLine
\ARPArrowBAseLine=-1ex
% usage: \UAC[color][scale] - Up Arrow for arpege
\NewDocumentCommand\UAC{O{black} O{1.0}}{\scalebox{#2}{\tikz[baseline=-\ARPArrowSize/2,,>={Stealth}]{
    \path[draw=#1,line width=1.5pt,->](0ex,-\ARPArrowSize+\ARPArrowBAseLine)--(0ex,\ARPArrowSize+\ARPArrowBAseLine);
    }}}
% usage: \DAC[color][scale] - Down Arrow for arpege
\NewDocumentCommand\DAC{O{black} O{1.0}}{\scalebox{#2}{\tikz[baseline=-\ARPArrowSize/2,>={Stealth}]{\path[draw=#1,line width=1.5pt,->](0ex,\ARPArrowSize+\ARPArrowBAseLine)--(0ex,-\ARPArrowSize+\ARPArrowBAseLine);}}}

% usage: \UCA{note F}{note T}{note Q}{F or T or Q}[scale]  - Arpege UP 
\NewDocumentCommand\UCA{mmmm O{1.0}}{\UAC\CH{#1}{#2}{#3}{#4}[#5]}
% usage: \DCA{note F}{note T}{note Q}[F or T or Q][scale]  - Arpege down 
\NewDocumentCommand\DCA{mmmm O{1.0}}{\DAC\CH{#1}{#2}{#3}{#4}[#5]}

%%%%%%
% Cadence
%%%%%%

% usage: \Cadence{Chord ... Chord}[scale]  - Several Chords in a string 
\ExplSyntaxOn
\NewDocumentCommand\Cadence{m O{1.0}}
{
    \ParseCadence{#1}
    
    
    % Parse each Chord
    \seq_map_indexed_inline:Nn \l__Cadence_seq   
    {
        \tl_set:Ne \l__CleanF_tl {\seq_item:Nn \l__CleanF_seq {##1}}
        \tl_set:Ne \l__CleanT_tl {\seq_item:Nn \l__CleanT_seq {##1}}
        \tl_set:Ne \l__CleanQ_tl {\seq_item:Nn \l__CleanQ_seq {##1}}
        
        \str_set:Ne \l__MuteF_bool_str {\seq_item:Nn \l__MuteF_bool_seq {##1}}
        \str_set:Ne \l__MuteT_bool_str {\seq_item:Nn \l__MuteT_bool_seq {##1}}
        \str_set:Ne \l__MuteQ_bool_str {\seq_item:Nn \l__MuteQ_bool_seq {##1}}
    
        \tl_set:Ne \l__Arpege_tl {\seq_item:Nn \l__Arpege_seq {##1}}
        \tl_set:Ne \l__Arpege_bool_str {\seq_item:Nn \l__Arpege_bool_seq {##1}}
        
        % constante in fact to test bool
        \str_set:Nn \l__true_str {true}
    
        % create the 3 Notes (Muted or not Muted)
        \str_if_eq:NNTF \l__MuteF_bool_str \l__true_str
            {% Generate the XClean Note
            \tl_set_eq:NN \l__F_tl \l__CleanF_tl
            \tl_put_left:Nn \l__F_tl {dcX}
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__F_tl}
                {}%ok
                {\tl_set:Nn \l__F_tl {dcXUKw}}                
            }
            {% Generate the Clean note
            \tl_set_eq:NN \l__F_tl \l__CleanF_tl
            \tl_put_left:Nn \l__F_tl {dc} 
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__F_tl}
                {}%ok
                {\tl_set:Nn \l__F_tl {dcUKw}}                
            }
        \str_if_eq:NNTF \l__MuteT_bool_str \l__true_str
            {% Generate the XClean Note
            \tl_set_eq:NN \l__T_tl \l__CleanT_tl
            \tl_put_left:Nn \l__T_tl {dcX} 
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__T_tl}
                {}%ok
                {\tl_set:Nn \l__T_tl {dcXUKw}}                
            }
            {% Generate the Clean note
            \tl_set_eq:NN \l__T_tl \l__CleanT_tl
            \tl_put_left:Nn \l__T_tl {dc} 
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__T_tl}
                {}%ok
                {\tl_set:Nn \l__T_tl {dcUKw}}                
            }
        \str_if_eq:NNTF \l__MuteQ_bool_str \l__true_str
            {% Generate the XClean Note
            \tl_set_eq:NN \l__Q_tl \l__CleanQ_tl
            \tl_put_left:Nn \l__Q_tl {dcX} 
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__Q_tl}
                {}%ok
                {\tl_set:Nn \l__Q_tl {dcXUKw}}
            }
            {% Generate the Clean note
            \tl_set_eq:NN \l__Q_tl \l__CleanQ_tl
            \tl_put_left:Nn \l__Q_tl {dc} 
                % If not exist replace by the unknown note
                \cs_if_exist:cTF {\l__Q_tl}
                {}%ok
                {\tl_set:Nn \l__Q_tl {dcUKw}}
            }
        
        % Draw \CE, \DCA or \UCA
        \str_if_eq:NNTF \l__Arpege_bool_str \l__true_str
        {% Yes Arpege
            \str_set:Nn \D {D} 
            \str_if_eq:NNTF \l__Arpege_tl \D
            { % Down
                \DCA{\use:c {\l__F_tl}}{\use:c {\l__T_tl}}{\use:c {\l__Q_tl}}{\l__Inversion_tl}[#2] \quad             
            }
            { % UP
                \UCA{\use:c {\l__F_tl}}{\use:c {\l__T_tl}}{\use:c {\l__Q_tl}}{\l__Inversion_tl}[#2] \quad
            }
        }
        {% NO Arpege
            \CH{\use:c {\l__F_tl}}{\use:c {\l__T_tl}}{\use:c {\l__Q_tl}}{\l__Inversion_tl}[#2] \quad
        }    
    }
}
\ExplSyntaxOff


%%%%%%
% Decoration
%%%%%%

% usage: \LO{color}[scale] - Flamme Symbol
\NewDocumentCommand\LO{m O{1.0}}{\scalebox{#2}{\tikz[baseline=-0.5ex]{
    \path[draw=#1,line width=1.5pt,-] (0ex,-0.5ex)--(1ex,1ex);
    }}}
% usage: \FL{color}[note][scale] - Flamme
\NewDocumentCommand\FL{mo O{1.0}}{\IfNoValueTF{#2}{\LO{#1}[#3]}{\LO{#1}[#3] #2}}

% usage: \BFL[note][scale] - Flamme
% for debug only test with no parameter
% TODO delete
\NewDocumentCommand\BFL{O{1.0}}{\LO{red}}

% usage: \CR{color}[text] - [ text ]
\NewDocumentCommand\CR{mo}{\IfNoValueTF{#2}{{\space}{\textcolor{#1}{\lbrack \rbrack}}{\space}}
{{\space}{\textcolor{#1}{\lbrack}}{\space}#2{\space}{\textcolor{#1}{\rbrack}}{\space}}}

