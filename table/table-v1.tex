\def\tabver{V185}

\usepackage{nicematrix} %Block

%%%%
\input{table/tbparse-v1}
%%%%

% background
\def\LIGHT{10}
\colorlet{dolight}{do!\LIGHT!white}
\colorlet{relight}{re!\LIGHT!white}
\colorlet{milight}{mi!\LIGHT!white}
\colorlet{falight}{fa!\LIGHT!white}
\colorlet{sollight}{sol!\LIGHT!white}
\colorlet{lalight}{la!\LIGHT!white}
\colorlet{silight}{si!\LIGHT!white}

\def\VLIGHT{05}
\colorlet{dovlight}{do!\VLIGHT!white}
\colorlet{revlight}{re!\VLIGHT!white}
\colorlet{mivlight}{mi!\VLIGHT!white}
\colorlet{favlight}{fa!\VLIGHT!white}
\colorlet{solvlight}{sol!\VLIGHT!white}
\colorlet{lavlight}{la!\VLIGHT!white}
\colorlet{sivlight}{si!\VLIGHT!white}
\colorlet{grayvlight}{gray!\VLIGHT!white}

\newcolumntype{P}[1]{>{\centering\arraybackslash}b{#1}}
\newcolumntype{N}{@{}m{0pt}@{}}


% Parse Pages in Pages / Lignes and contents
% then Draw
% Usage Pages{Name of file with content}
\ExplSyntaxOn
\NewDocumentCommand\Pages{m}
{    
    % Temp variables
    \seq_clear_new:N \l__allPageTitle_seq
    \seq_clear_new:N \l__allNbLignebyPage_seq
    
    \seq_clear_new:N \l__allLineTitle_seq
    \seq_clear_new:N \l__allNbContentbyLine_seq
    
    \seq_clear_new:N \l__allClass_seq
    \seq_clear_new:N \l__allCleanContent_seq

    % at the Page level
    \tl_clear_new:N \l__PageContent_tl
    \int_zero_new:N \l__LineNB_int

    % at the Line level
    \tl_clear_new:N \l__FullLineTitle_tl
    \int_zero_new:N \l__contentNB_int
    \tl_clear_new:N \l__contentNB_tl

    % at the content level
    \tl_clear_new:N \l__CurrentClass_tl
    \tl_clear_new:N \l__ContentClass_tl
    \tl_clear_new:N \l__Content_tl
    
    
    % PARSE
    
    % split the content by Page
    \ParsePages{#1} 

    % go-on if not empty
    \tl_if_blank:nTF {\l__Pages_tl}
        {}%empty
        {% not empty
         % for each Pages
            \seq_map_inline:Nn \l__Pages_seq 
            {
            % split the page by Line
            \ParsePage{##1}
            
            % store at the page level
            \seq_put_right:NV \l__allPageTitle_seq \l__PageTitle_tl
            \seq_put_right:Ne \l__allNbLignebyPage_seq {\seq_count:N \l__Page_seq}
            

            % go-on if not empty
            \tl_if_blank:nTF {\l__Page_tl}
                {}%empty
                {% not empty
                 % for each Line
                \seq_map_inline:Nn \l__Page_seq
                    {                   
                    %split the Line by Content
                    \ParseLine{####1}
                    
                    % store at the Line level
                    \seq_put_right:NV \l__allLineTitle_seq \l__LineTitle_tl
                    \seq_put_right:Ne \l__allNbContentbyLine_seq {\seq_count:N \l__Line_seq}
                    
                    % go-on if not empty
                    \tl_if_blank:nTF {\l__Line_tl}
                        {}%empty
                        {% not empty
                        % for each content
                        \seq_map_inline:Nn \l__Line_seq
                            {                   
                                %Parse to get Class
                                \ParseContent{########1}
                                
                                % store at the Content level
                                \seq_put_right:NV \l__allClass_seq \l__Class_tl
                                \seq_put_right:NV \l__allCleanContent_seq \l__CleanContent_tl
                            }
                        }
                    }
                }
            }
        }

        % Trace
        \iow_term:n {Pages}
        \seq_show:N \l__allPageTitle_seq
        \seq_show:N \l__allNbLignebyPage_seq
    
        \seq_show:N \l__allLineTitle_seq
        \seq_show:N \l__allNbContentbyLine_seq
    
        \seq_show:N \l__allClass_seq
        \seq_show:N \l__allCleanContent_seq

    % DRAW

    % For each Page
    \seq_map_indexed_inline:Nn \l__allPageTitle_seq
    {% for each Page

        % Parse and Draw Title
        \ParsePageTitle{##2}
        \fancyhead[C]{\textbf{\l__CleanPageTitle_tl}}
        
        % Prepare the content to draw clean the content
        \tl_clear_new:N \l__PageContent_tl

        % nb of ligne to draw
        \int_set:Nn \l__LineNB_int {\seq_item:Nn \l__allNbLignebyPage_seq ##1}

        % for each line
        \int_while_do:nn {\l__LineNB_int > 0}
            {
            % Draw the title line of the line
                % read and consume the title
                \seq_pop_left:NN \l__allLineTitle_seq \l__FullLineTitle_tl
                %parse
                \ParseLineTitle{\l__FullLineTitle_tl}
                %draw
                \seq_map_indexed_inline:Nn \l__LineTitles_seq
                    {
                    \tl_put_right:Ne \l__PageContent_tl {\RowTitle{####2}}
                    }
                \tl_put_right:Ne \l__PageContent_tl {\EOL}
            
            % Draw the content line of the line
                % consume the number of content
                % default Class = s
                \tl_set:Nn \l__CurrentClass_tl {s}
                \seq_pop_left:NN \l__allNbContentbyLine_seq \l__contentNB_tl
                \int_set:Nn \l__contentNB_int {\l__contentNB_tl}
                \int_while_do:nn {\l__contentNB_int > 0}
                    {
                    % read and consume the Class & Content
                    \seq_pop_left:NN \l__allClass_seq \l__ContentClass_tl
                    \seq_pop_left:NN \l__allCleanContent_seq \l__Content_tl

                    % HERE !!!!!! Draw Content with Class
					\DrawContent{\l__ContentClass_tl}{\l__Content_tl}
					\tl_put_right:Ne \l__PageContent_tl { \l__DrawableContent_tl}

%					\tl_put_right:NV \l__PageContent_tl {  \l__Content_tl&}
 
                     % mandatory
                    \int_decr:N \l__contentNB_int
                    }
                    \tl_put_right:Ne \l__PageContent_tl {\EOL}
                
                % mandatory
                \int_decr:N \l__LineNB_int
            }
        
        \bool_if:NTF \l__Half_bool
            {\PageH{\l__PageContent_tl}}
            {\PageD{\l__PageContent_tl}}    
    }       
}
\ExplSyntaxOff

\ExplSyntaxOn
% DrawContent with the right class {Class}{Content}
\NewDocumentCommand\DrawContent{mm}
{
	 % Temp variables
	\tl_clear_new:N \l__TheClass_tl
	\tl_set:Ne \l__TheClass_tl {#1}
	\tl_clear_new:N \l__TheContent_tl
	\tl_set:Ne \l__TheContent_tl {#2}


	% Result variables at the Content level
	\tl_clear_new:N \l__DrawableContent_tl
	
	
	% init default Class if required
	\tl_if_empty:NTF \l__TheClass_tl
	{% empty put the Current
		\tl_set:NV  \l__TheClass_tl  \l__CurrentClass_tl
	}
	{} %not empty
	
% |O = Phrase scale =1 - 2 col
% |o = Phrase scale=.5 - 1 col
% |C = suite de Chords - 2 col
% |c = suite de Chords - 1 col
% |M = Master- 2 col
% |m = Master - 1 col
% |N = suite de Notes séparateur de block - 2 col
% |n = suite de Notes séparateur de block - 1 col
% |S = suite de symboles (commandes latex) - 2 col
% |s = suite de symboles (commandes latex) - 1 col
% | = identique au précedant defaut s
% |1 ou 2 = une ou deux colonnes vide


	\str_case:NnTF \l__TheClass_tl % what Class
	{
	{O}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{\Phrase{\l__TheContent_tl}}}				}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{{\l__TheContent_tl}}}				}
	{o}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{\Phrase{\l__TheContent_tl}[0.5]}}	}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{{\l__TheContent_tl}[0.5]}}	}
	{C}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{\Cadence{\l__TheContent_tl}}}	}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{{\l__TheContent_tl}}}		}
	{c}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{\Cadence{\l__TheContent_tl}}}		}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{{\l__TheContent_tl}}}		}
	{M}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{\Master{\l__TheContent_tl}}}		}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{{\l__TheContent_tl}}}		}
	{m}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{\Master{\l__TheContent_tl}}}		}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{{\l__TheContent_tl}}}		}
	{N}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{\NotesBox{\l__TheContent_tl}}}		}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{{\l__TheContent_tl}}}		}
	{n}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{\NotesBox{\l__TheContent_tl}}}		}
%			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{{\l__TheContent_tl}}}		}
	{S}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{\l__TheContent_tl}}		}
	{s}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{\l__TheContent_tl}}		}
	{2}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BTwo{}}		}
	{1}
			{	\tl_set:Nn  \l__DrawableContent_tl  {\BOne{}}		}
	
	}
	{% additional things if found
		\tl_set:NV  \l__CurrentClass_tl  \l__TheClass_tl
		}
	{% additional things if other
		\tl_set:Nn  \l__DrawableContent_tl  {Not Found&}
	}
	
        % Trace
		\iow_term:n {\DrawContent}
		\tl_show:N \l__TheClass_tl
		\tl_show:N \l__TheContent_tl 
		\tl_show:N \l__DrawableContent_tl
}
\ExplSyntaxOff


\ExplSyntaxOn
% \NotesBox Draw a box of Notes 1/2 or 3 lines { Notes  - Notes} / -  = new line
\NewDocumentCommand\NotesBox{m}
{
	% Temp variables
	\tl_clear_new:N \l__TheNotes_tl
	\tl_set:Ne \l__TheNotes_tl {#1}
	\seq_clear_new:N \l__Split_seq
	\tl_clear_new:N \l__NBLines_tl
	
	% split the lines
	\seq_set_split:Nnx \l__Split_seq {-} {\l__TheNotes_tl}
	\tl_set:Ne \l__NBLines_tl {\seq_count:N  \l__Split_seq }
	
	\str_case:NnTF \l__NBLines_tl % Nb ligne
	{
	{0}
			{}
	{1}
			{\BTx{\Notes{\seq_item:Nn \l__Split_seq 1 }}}
	{2}
			{\BTx{\Notes{\seq_item:Nn \l__Split_seq 1 }[\seq_item:Nn \l__Split_seq 2 ]}}
	{3}
			{\BTx{\Notes{\seq_item:Nn \l__Split_seq 1 }[\seq_item:Nn \l__Split_seq 2 ][\seq_item:Nn \l__Split_seq 4]}}					
	
	}
	{}% nothing else if found
	{Error in NotesBox} % if not Fount
	
	      % Trace
		\iow_term:n {NotesBox}
		\tl_show:N \l__TheNotes_tl
		\seq_show:N \l__Split_seq
		\tl_show:N \l__NBLines_tl 
		
}
\ExplSyntaxOff

% Usage Page 16 col- Print a table in a page
\NewDocumentCommand\PageD{+m}
{
\begin{table}[h!]
\centering
    \newdimen\CellWidth
    \CellWidth=10ex
    \newdimen\smallCellWidth
    \smallCellWidth=0.25pt
    \begin{NiceTabular}{|*{4}{P{\CellWidth}}|*{4}{P{\CellWidth}}|*{4}{P{\CellWidth}}|*{4}{P{\CellWidth}}|P{\smallCellWidth}}        
    \hline
    1&2&3&4&5&6&7&8&9&10&11&12&13&14&15&16\\
    \hline 
    #1
    \end{NiceTabular}
\end{table} 
\newpage
}
% Usage Page 8 col- Print a table in a page
\NewDocumentCommand\PageH{+m}
{
\begin{table}[h!]
\centering
    \newdimen\CellWidth
    \CellWidth=10ex
    \newdimen\smallCellWidth
    \smallCellWidth=0.25pt
    \begin{NiceTabular}{|*{4}{P{\CellWidth}}|*{4}{P{\CellWidth}}|P{\smallCellWidth}}        
    \hline
    1&2&3&4&5&6&7&8\\
    \hline 
    #1
    \end{NiceTabular}
\end{table} 
\newpage
}



% Usage PhraseA/B
\NewDocumentCommand\PhraseA{m O{white} ooo}
{
\rowcolor{#2}
\RowTitle{#1}
\IfNoValueTF{#3}{}{&&&&\RowTitle{#3}}
\IfNoValueTF{#4}{}{&&&&\RowTitle{#4}}
\IfNoValueTF{#5}{}{&&&&\RowTitle{#5}}
\\ \rowcolor{#2}
}

\NewDocumentCommand\PhraseB{mm mm mm mm}
{
\BTwo{\Phrase{#1}}&\BTwo{\Phrase{#2}}&
\BTwo{\Phrase{#3}}&\BTwo{\Phrase{#4}}&
\BTwo{\Phrase{#5}}&\BTwo{\Phrase{#6}}&
\BTwo{\Phrase{#7}}&\BTwo{\Phrase{#8}}
\\
\hline
}

% Usage Master A/B 
\NewDocumentCommand\MasterA{m O{white} ooo}
{
\rowcolor{#2}
\RowTitle{#1}
\IfNoValueTF{#3}{}{&&&&\RowTitle{#3}}
\IfNoValueTF{#4}{}{&&&&\RowTitle{#4}}
\IfNoValueTF{#5}{}{&&&&\RowTitle{#5}}
\\ \rowcolor{#2}
}

\NewDocumentCommand\MasterB{mm mm mm mm}
{
\BTwo{\Master{#1}}&\BTwo{\Master{#2}}&
\BTwo{\Master{#3}}&\BTwo{\Master{#4}}&
\BTwo{\Master{#5}}&\BTwo{\Master{#6}}&
\BTwo{\Master{#7}}&\BTwo{\Master{#8}}
\\
\hline
}

% Simple A/B/C
\NewDocumentCommand\SimpleRowA{m O{white}}
{
\rowcolor{#2}
\RowTitle{#1}\\
\rowcolor{#2}
}

\NewDocumentCommand\SimpleRowB{mm mm mm mm}
{
\BOne{#1}&\BOne{#2}&
\BOne{#3}&\BOne{#4}&
\BOne{#5}&\BOne{#6}&
\BOne{#7}&\BOne{#8}&
}

\NewDocumentCommand\SimpleRowC{mm mm mm mm}
{
\BOne{#1}&\BOne{#2}&
\BOne{#3}&\BOne{#4}&
\BOne{#5}&\BOne{#6}&
\BOne{#7}&\BOne{#8}
\\
\hline
}

% Usage RowTitle - Print the title of a row {Text}
\NewDocumentCommand\RowTitle{m}{
    \Block[l]{1-4}{\textbf{#1}}&&&&
}

% Usage BTwo - Block of 2 Columns {Content}
\NewDocumentCommand\BTwo{m}{
    \Block{1-2}{#1}&&
}
% Usage BOne - Block of 1 Columns {Content}
\NewDocumentCommand\BOne{m}{
\Block{1-1}{#1}&
}
% Usage BTx - Text Block 1,2 or 3 lignes {Content}[Content][Content]
\NewDocumentCommand\BTx{moo O{1.0}}{\scalebox{#4}{\tikz[baseline=0.ex]{
    \begin{scope}[node distance=0.4ex,inner sep=0pt,node font=\large]
        \IfNoValueTF{#2} % 1 ligne
            {
            \node[anchor=base] (M) at (0,0) {\Notes{#1}};
            \node [above=of M,anchor=south] (T) {};
            \node [below=of M,anchor=north] (B) {};
            }
            {\IfNoValueTF{#3}
                {% 2 ligne
                \node[anchor=base] (M) at (0,0) {};
                \node [above=of M,anchor=south] (T) {\Notes{#1}};
                \node [below=of M,anchor=north] (B) {\Notes{#2}};
                
                }
                {% 3 ligne
                \node[anchor=base] (M) at (0,0) {\Notes{#2}};
                \node [above=of M,anchor=south] (T) {\Notes{#1}};
                \node [below=of M,anchor=north] (B) {\Notes{#3}};
                }
            }     
        \node [above=of T,anchor=south] (H) {};% extra space at TOP
        \node [below=of B,anchor=north] (L) {};% extra space at BOTTOM
    \end{scope}&
    }}}

% Usage EOL - insert \\
 \NewDocumentCommand\EOL{}{\\}
 % Usage EOL - insert \\
 \NewDocumentCommand\EOLHline{}{\\ \hline}
